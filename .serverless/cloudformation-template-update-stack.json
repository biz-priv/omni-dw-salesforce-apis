{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "The AWS CloudFormation template for this Serverless application",
  "Resources": {
    "ServerlessDeploymentBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        }
      }
    },
    "ServerlessDeploymentBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "ServerlessDeploymentBucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Effect": "Deny",
              "Principal": "*",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition"
                      },
                      ":s3:::",
                      {
                        "Ref": "ServerlessDeploymentBucket"
                      },
                      "/*"
                    ]
                  ]
                }
              ],
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": false
                }
              }
            }
          ]
        }
      }
    },
    "SalesForceApiLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/aws/lambda/omni-dw-dev-SalesForceApi"
      }
    },
    "CreateDynamoTablesLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/aws/lambda/omni-dw-dev-CreateDynamoTables"
      }
    },
    "CommonLibsLambdaLayer": {
      "Type": "AWS::Lambda::LayerVersion",
      "Properties": {
        "Content": {
          "S3Bucket": {
            "Ref": "ServerlessDeploymentBucket"
          },
          "S3Key": "serverless/omni-dw/dev/1643355628186-2022-01-28T07:40:28.186Z/commonLibs.zip"
        },
        "LayerName": "commonLibs",
        "CompatibleRuntimes": [
          "nodejs14.x"
        ]
      }
    },
    "SalesForceApiLambdaFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "ServerlessDeploymentBucket"
          },
          "S3Key": "serverless/omni-dw/dev/1643359315732-2022-01-28T08:41:55.732Z/SalesForceApi.zip"
        },
        "FunctionName": "omni-dw-dev-SalesForceApi",
        "Handler": "src/SalesForceApi/index.handler",
        "MemorySize": 128,
        "Role": "arn:aws:iam::332281781429:role/dw-lambda-redshift-role",
        "Runtime": "nodejs14.x",
        "Timeout": 30,
        "Environment": {
          "Variables": {
            "stage": "dev",
            "DB_PORT": "5439",
            "DB_HOST": "10.9.130.79",
            "DB_PASSWORD": "BizCloudExp1",
            "DB_DATABASE": "prod_datamodel",
            "DB_USER": "bceuser1",
            "DEFAULT_AWS": "us-east-1",
            "CHILD_RECORD_TYPE_ID": "0128B00000007WJQAY",
            "PARENT_RECORDS_TYPE_ID": "0128B00000007WKQAY",
            "PARENT_ACCOUNT_DYNAMO_TABLE": "salesforce_parent_account_records",
            "CHILD_ACCOUNT_DYNAMO_TABLE": "salesforce_child_accounts_records",
            "SALE_FORECAST_DYNAMO_TABLE": "sales_forecast_records",
            "FETCH_CHILD_ACCOUNT_BASE_URL": "/services/data/v53.0/sobjects/Account",
            "TOKEN_BASE_URL": "https://test.salesforce.com/services/oauth2/token?grant_type=password&client_id=3MVG9MwiKwcReohwD7S1akUYBk4hpvo4cSXMxBGdTyypmZ0WOO6a8PBvfLYh6yzB1x70uJs5zDA==&client_secret=E8C29994EABD68BE28F127C98477FB726024A0D8E429104028DB50DC879D7BC0&username=sandboxsalesforceintegrations@omnilogistics.com.uatfull&password=q*B04Nf5%23@2utJS7Nn3B0kTNZiXPzBLaDVRjW",
            "PARENT_ACCOUNT_BASE_URL": "/services/data/v53.0/sobjects/Account/Unique_Id__c/",
            "OWNER_USER_ID_BASE_URL": "/services/data/v53.0/sobjects/User/Unique_Name__c/",
            "CHILD_ACCOUNT_BASE_URL": "/services/data/v53.0/sobjects/Account/Unique_Id__c/",
            "SALES_FORECAST_RECORD_ID_BASE_URL": "/services/data/v53.0/sobjects/Sales_Forecast__c/Unique_Id__c/",
            "UPSERT_SALES_FORECAST_DETAILS_BASE_URL": "/services/data/v53.0/sobjects/Sales_Forecast_Detail__c/Unique_Id__c/",
            "TIMESTAMP_SSM_PARAMETER": "/omni-dw/salesforce/dev/db/tables/latest/timestamp",
            "SMTP_HOST": "email-smtp.us-east-1.amazonaws.com",
            "SMTP_PORT": "587",
            "SMTP_USER": "AKIAXLP624BLJQ5JICVQ",
            "SMTP_PASSWORD": "BFzlzKrkZAIdRqFu3BoxO1uGRNCjqGUfEeZN/JpTaIuV",
            "SMTP_SENDER": "reports@omnilogistics.com",
            "SMTP_RECEIVER": "sujit.das@bizcloudexperts.com"
          }
        },
        "VpcConfig": {
          "SecurityGroupIds": [
            "sg-02f89a176b75daa56"
          ],
          "SubnetIds": [
            "subnet-01b73865bdb44c156"
          ]
        },
        "Layers": [
          {
            "Ref": "CommonLibsLambdaLayer"
          }
        ]
      },
      "DependsOn": [
        "SalesForceApiLogGroup"
      ]
    },
    "SalesForceApiLambdaVersionjp5oP0AV12SGBL97YBrzUexkMFZ6ciUCTrnexRjp2Q": {
      "Type": "AWS::Lambda::Version",
      "DeletionPolicy": "Retain",
      "Properties": {
        "FunctionName": {
          "Ref": "SalesForceApiLambdaFunction"
        },
        "CodeSha256": "+t/T1yruQx984qHKLU47dainO9Nn/0GBLrtQ7ZnyCCY="
      }
    },
    "CreateDynamoTablesLambdaFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "ServerlessDeploymentBucket"
          },
          "S3Key": "serverless/omni-dw/dev/1643359315732-2022-01-28T08:41:55.732Z/CreateDynamoTables.zip"
        },
        "FunctionName": "omni-dw-dev-CreateDynamoTables",
        "Handler": "src/CreateDynamoTables/index.handler",
        "MemorySize": 128,
        "Role": "arn:aws:iam::332281781429:role/dw-lambda-redshift-role",
        "Runtime": "nodejs14.x",
        "Timeout": 30,
        "Environment": {
          "Variables": {
            "stage": "dev",
            "DEFAULT_AWS": "us-east-1",
            "PARENT_ACCOUNT_DYNAMO_TABLE": "salesforce_parent_account_records",
            "CHILD_ACCOUNT_DYNAMO_TABLE": "salesforce_child_accounts_records",
            "SALE_FORECAST_DYNAMO_TABLE": "sales_forecast_records"
          }
        },
        "VpcConfig": {
          "SecurityGroupIds": [
            "sg-02f89a176b75daa56"
          ],
          "SubnetIds": [
            "subnet-01b73865bdb44c156"
          ]
        },
        "Layers": [
          {
            "Ref": "CommonLibsLambdaLayer"
          }
        ]
      },
      "DependsOn": [
        "CreateDynamoTablesLogGroup"
      ]
    },
    "CreateDynamoTablesLambdaVersionlFbZlu5zRQJMs7AQfgH7t6VxRWGgfa7Mo1ZkYCEQ": {
      "Type": "AWS::Lambda::Version",
      "DeletionPolicy": "Retain",
      "Properties": {
        "FunctionName": {
          "Ref": "CreateDynamoTablesLambdaFunction"
        },
        "CodeSha256": "w0C6lj7/Ey+/fxc7YeQOUU3s0UHRfDsY0PsBwOPcA3Q="
      }
    }
  },
  "Outputs": {
    "ServerlessDeploymentBucketName": {
      "Value": {
        "Ref": "ServerlessDeploymentBucket"
      }
    },
    "CommonLibsLambdaLayerQualifiedArn": {
      "Description": "Current Lambda layer version",
      "Value": {
        "Ref": "CommonLibsLambdaLayer"
      }
    },
    "CommonLibsLambdaLayerHash": {
      "Description": "Current Lambda layer hash",
      "Value": "9d8997dc672bfbd75e277eacc3f9c053b501b850"
    },
    "CommonLibsLambdaLayerS3Key": {
      "Description": "Current Lambda layer S3Key",
      "Value": "serverless/omni-dw/dev/1643355628186-2022-01-28T07:40:28.186Z/commonLibs.zip"
    },
    "SalesForceApiLambdaFunctionQualifiedArn": {
      "Description": "Current Lambda function version",
      "Value": {
        "Ref": "SalesForceApiLambdaVersionjp5oP0AV12SGBL97YBrzUexkMFZ6ciUCTrnexRjp2Q"
      }
    },
    "CreateDynamoTablesLambdaFunctionQualifiedArn": {
      "Description": "Current Lambda function version",
      "Value": {
        "Ref": "CreateDynamoTablesLambdaVersionlFbZlu5zRQJMs7AQfgH7t6VxRWGgfa7Mo1ZkYCEQ"
      }
    }
  }
}